<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Design Stack v2 Report</title>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif&family=Outfit:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f6f4f0;
      --bg-deep: #eae7e1;
      --surface: #ffffff;
      --surface-warm: #fdfcfa;
      --ink: #1a1714;
      --ink-soft: #4a4640;
      --ink-muted: #8a857e;
      --ink-ghost: #bdb8b0;
      --accent: #2d5a3d;
      --accent-light: #e8f0eb;
      --accent-bright: #3a7a52;
      --signal-warn: #c17a28;
      --signal-warn-bg: #fef3e2;
      --signal-danger: #b83a3a;
      --signal-danger-bg: #fde8e8;
      --signal-info: #2d5a8a;
      --signal-info-bg: #e8f0fa;
      --signal-success: #2d5a3d;
      --signal-success-bg: #e8f0eb;
      --border: #e2dfd9;
      --border-strong: #ccc8c0;
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --shadow-sm: 0 1px 3px rgba(26,23,20,0.06);
      --shadow-md: 0 2px 8px rgba(26,23,20,0.08);
      --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Outfit', sans-serif; color: var(--ink); background: var(--bg); line-height: 1.6; }

    /* Header */
    .report-header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 32px 40px; }
    .report-header h1 { font-family: 'Instrument Serif', serif; font-size: 36px; font-weight: 400; margin-bottom: 4px; }
    .report-header .lens-label { font-size: 16px; color: var(--ink-soft); margin-bottom: 12px; }
    .report-meta { display: flex; gap: 24px; flex-wrap: wrap; color: var(--ink-muted); font-size: 13px; font-family: 'IBM Plex Mono', monospace; }
    .badge { display: inline-flex; align-items: center; gap: 6px; padding: 2px 10px; border-radius: 9999px; font-size: 12px; font-weight: 500; }
    .badge-complete { background: var(--accent-light); color: var(--accent); }
    .badge-partial { background: var(--signal-warn-bg); color: var(--signal-warn); }

    /* Coherence Alert Bar */
    .coherence-bar { background: var(--signal-warn-bg); border-bottom: 1px solid rgba(193,122,40,0.2); padding: 10px 40px; font-size: 13px; color: var(--signal-warn); display: none; align-items: center; gap: 12px; }
    .coherence-bar.has-flags { display: flex; }
    .coherence-bar .count { font-family: 'IBM Plex Mono', monospace; font-weight: 600; }

    /* Tab Nav */
    .tab-nav { position: sticky; top: 0; z-index: 100; background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 40px; display: flex; gap: 0; overflow-x: auto; box-shadow: var(--shadow-sm); }
    .tab-nav button { background: none; border: none; padding: 14px 20px; font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 500; color: var(--ink-muted); cursor: pointer; border-bottom: 2px solid transparent; transition: all 200ms var(--ease-out); white-space: nowrap; display: flex; align-items: center; gap: 8px; }
    .tab-nav button:hover { color: var(--ink-soft); }
    .tab-nav button.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-nav button .layer-num { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; border-radius: 50%; background: var(--bg-deep); font-size: 11px; font-family: 'IBM Plex Mono', monospace; font-weight: 600; color: var(--ink-muted); }
    .tab-nav button.active .layer-num { background: var(--accent); color: white; }

    /* Main */
    .main-content { max-width: 1200px; margin: 0 auto; padding: 32px 40px; }
    .tab-panel { display: none; animation: fadeIn 300ms var(--ease-out); }
    .tab-panel.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

    /* Element Card */
    .element-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 28px 32px; margin-bottom: 20px; box-shadow: var(--shadow-sm); }
    .element-card-header { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 16px; padding-bottom: 14px; border-bottom: 1px solid var(--border); flex-wrap: wrap; }
    .element-card-header h3 { font-family: 'Instrument Serif', serif; font-size: 22px; font-weight: 400; flex: 1; min-width: 200px; }
    .type-badge { padding: 3px 10px; border-radius: 9999px; font-size: 11px; font-family: 'IBM Plex Mono', monospace; font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em; }
    .type-process_pattern { background: #e8f0fa; color: #2d5a8a; }
    .type-info_architecture { background: #f0e8fa; color: #6a2d8a; }
    .type-visual_pattern { background: #fae8f0; color: #8a2d5a; }
    .type-interaction_pattern { background: #faf0e8; color: #8a5a2d; }
    .type-emotional_element { background: #e8faf0; color: #2d8a5a; }
    .type-validation_strategy { background: var(--bg-deep); color: var(--ink-soft); }
    .priority-badge { padding: 3px 10px; border-radius: 9999px; font-size: 11px; font-family: 'IBM Plex Mono', monospace; font-weight: 600; }
    .priority-high { background: var(--signal-danger-bg); color: var(--signal-danger); }
    .priority-medium { background: var(--signal-warn-bg); color: var(--signal-warn); }
    .priority-low { background: var(--bg-deep); color: var(--ink-muted); }

    /* Phase Tags */
    .phase-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 16px; }
    .phase-tag { padding: 2px 8px; border-radius: var(--radius-sm); font-size: 11px; font-family: 'IBM Plex Mono', monospace; background: var(--accent-light); color: var(--accent); }

    /* Problem/Solution */
    .ps-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .ps-box { padding: 14px 16px; border-radius: var(--radius-md); font-size: 14px; }
    .ps-box.problem { background: var(--signal-danger-bg); border-left: 3px solid var(--signal-danger); }
    .ps-box.solution { background: var(--signal-success-bg); border-left: 3px solid var(--signal-success); }
    .ps-box label { display: block; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--ink-muted); margin-bottom: 4px; font-family: 'IBM Plex Mono', monospace; }
    @media (max-width: 700px) { .ps-grid { grid-template-columns: 1fr; } }

    /* Evidence */
    .evidence-toggle { background: none; border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 6px 14px; font-size: 12px; font-family: 'IBM Plex Mono', monospace; cursor: pointer; color: var(--ink-muted); transition: all 150ms; }
    .evidence-toggle:hover { border-color: var(--accent); color: var(--accent); }
    .evidence-list { display: none; margin-top: 12px; }
    .evidence-list.open { display: block; }
    .evidence-item { padding: 10px 14px; margin: 6px 0; background: var(--surface-warm); border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 13px; }
    .evidence-item .source { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--accent); font-weight: 600; margin-bottom: 4px; }
    .evidence-item .quote { color: var(--ink-soft); font-style: italic; }
    .evidence-item .insight { color: var(--ink); margin-top: 4px; }

    /* Layer-specific fields */
    .extra-fields { margin-top: 16px; display: grid; gap: 8px; }
    .extra-field { font-size: 13px; }
    .extra-field label { font-weight: 600; color: var(--ink-soft); font-size: 12px; }
    .extra-field .value { color: var(--ink); }

    /* Coherence sections */
    .coherence-section { margin-bottom: 28px; }
    .coherence-section h3 { font-family: 'Instrument Serif', serif; font-size: 20px; font-weight: 400; margin-bottom: 12px; }
    .reinforcement-card { padding: 14px 16px; margin: 8px 0; border-radius: var(--radius-md); background: var(--signal-success-bg); border-left: 4px solid var(--signal-success); font-size: 14px; }
    .contradiction-card { padding: 14px 16px; margin: 8px 0; border-radius: var(--radius-md); background: var(--signal-danger-bg); border-left: 4px solid var(--signal-danger); font-size: 14px; }
    .extension-card { padding: 14px 16px; margin: 8px 0; border-radius: var(--radius-md); background: var(--signal-info-bg); border-left: 4px solid var(--signal-info); font-size: 14px; }
    .card-label { font-family: 'IBM Plex Mono', monospace; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }

    /* Coverage Map */
    .coverage-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin: 16px 0; }
    .coverage-cell { padding: 12px; border-radius: var(--radius-md); text-align: center; border: 1px solid var(--border); }
    .coverage-cell .phase-name { font-family: 'IBM Plex Mono', monospace; font-size: 11px; font-weight: 600; color: var(--ink-muted); margin-bottom: 4px; }
    .coverage-cell .count { font-size: 24px; font-weight: 700; }
    .coverage-cell .level { font-size: 11px; color: var(--ink-muted); }
    .coverage-none { background: var(--signal-danger-bg); }
    .coverage-thin { background: var(--signal-warn-bg); }
    .coverage-moderate { background: var(--signal-info-bg); }
    .coverage-strong { background: var(--signal-success-bg); }

    /* Journey Context phase cards */
    .phase-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 20px; margin-bottom: 12px; }
    .phase-card h4 { font-family: 'IBM Plex Mono', monospace; font-size: 13px; font-weight: 600; color: var(--accent); margin-bottom: 8px; text-transform: uppercase; }
    .phase-card p { font-size: 14px; color: var(--ink-soft); margin-bottom: 6px; }
    .phase-card .risk { font-size: 12px; font-family: 'IBM Plex Mono', monospace; padding: 2px 8px; border-radius: 9999px; display: inline-block; margin-top: 6px; }
    .risk-critical { background: var(--signal-danger-bg); color: var(--signal-danger); }
    .risk-high { background: var(--signal-warn-bg); color: var(--signal-warn); }
    .risk-medium { background: var(--signal-info-bg); color: var(--signal-info); }
    .risk-low { background: var(--bg-deep); color: var(--ink-muted); }

    /* Responsive + Print */
    @media (max-width: 768px) { .report-header, .main-content, .tab-nav, .coherence-bar { padding-left: 20px; padding-right: 20px; } }
    @media print { .tab-nav, .coherence-bar { display: none; } .tab-panel { display: block !important; page-break-inside: avoid; } body { background: white; } }
  </style>
</head>
<body>

  <!-- Data injection points -->
  <!-- INJECT:run-config -->
  <script id="run-config" type="application/json">{"run_id":"","lens":{},"status":"pending"}</script>
  <!-- INJECT:layer-0 -->
  <script id="data-layer-0" type="application/json">{}</script>
  <!-- INJECT:layer-1 -->
  <script id="data-layer-1" type="application/json">{}</script>
  <!-- INJECT:layer-2 -->
  <script id="data-layer-2" type="application/json">{}</script>
  <!-- INJECT:layer-3 -->
  <script id="data-layer-3" type="application/json">{}</script>
  <!-- INJECT:layer-4 -->
  <script id="data-layer-4" type="application/json">{}</script>
  <!-- INJECT:layer-5 -->
  <script id="data-layer-5" type="application/json">{}</script>
  <!-- INJECT:layer-6 -->
  <script id="data-layer-6" type="application/json">{}</script>
  <!-- INJECT:layer-7 -->
  <script id="data-layer-7" type="application/json">{}</script>

  <header class="report-header">
    <h1>Design Stack v2 Report</h1>
    <div class="lens-label" id="lens-label"></div>
    <div class="report-meta">
      <span id="meta-date"></span>
      <span id="meta-run-id"></span>
      <span class="badge" id="meta-status"></span>
      <span id="meta-elements"></span>
    </div>
  </header>

  <div class="coherence-bar" id="coherence-bar">
    <span class="count" id="coherence-count"></span>
    <span id="coherence-summary"></span>
  </div>

  <nav class="tab-nav" id="tab-nav">
    <button class="active" data-tab="overview"><span class="layer-num">*</span> Overview</button>
    <button data-tab="layer-0"><span class="layer-num">0</span> Journey</button>
    <button data-tab="layer-1"><span class="layer-num">1</span> Works</button>
    <button data-tab="layer-2"><span class="layer-num">2</span> Communicates</button>
    <button data-tab="layer-3"><span class="layer-num">3</span> Looks</button>
    <button data-tab="layer-4"><span class="layer-num">4</span> Behaves</button>
    <button data-tab="layer-5"><span class="layer-num">5</span> Feels</button>
    <button data-tab="layer-6"><span class="layer-num">6</span> Coherence</button>
    <button data-tab="layer-7"><span class="layer-num">7</span> Tests</button>
  </nav>

  <main class="main-content">

    <!-- Overview Tab -->
    <div class="tab-panel active" id="panel-overview">
      <div class="element-card">
        <h3 style="font-family:'Instrument Serif',serif;font-size:24px;font-weight:400;margin-bottom:16px;">Lens Summary</h3>
        <p id="overview-lens-summary" style="font-size:16px;color:var(--ink-soft);margin-bottom:20px;"></p>
        <h4 style="font-size:13px;font-weight:600;color:var(--ink-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:12px;font-family:'IBM Plex Mono',monospace;">Journey Phase Coverage</h4>
        <div class="coverage-grid" id="overview-coverage"></div>
        <h4 style="font-size:13px;font-weight:600;color:var(--ink-muted);text-transform:uppercase;letter-spacing:0.05em;margin:20px 0 12px;font-family:'IBM Plex Mono',monospace;">Run Statistics</h4>
        <div id="overview-stats" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;"></div>
      </div>
      <div id="overview-highlights"></div>
    </div>

    <!-- Layer 0: Journey Context -->
    <div class="tab-panel" id="panel-layer-0">
      <div class="element-card">
        <h3 style="font-family:'Instrument Serif',serif;font-size:24px;font-weight:400;margin-bottom:16px;">Layer 0: Journey Context</h3>
        <div id="content-layer-0"></div>
      </div>
    </div>

    <!-- Layers 1-5: Element Cards -->
    <div class="tab-panel" id="panel-layer-1"><div id="content-layer-1"></div></div>
    <div class="tab-panel" id="panel-layer-2"><div id="content-layer-2"></div></div>
    <div class="tab-panel" id="panel-layer-3"><div id="content-layer-3"></div></div>
    <div class="tab-panel" id="panel-layer-4"><div id="content-layer-4"></div></div>
    <div class="tab-panel" id="panel-layer-5"><div id="content-layer-5"></div></div>

    <!-- Layer 6: Coherence -->
    <div class="tab-panel" id="panel-layer-6">
      <div id="content-layer-6"></div>
    </div>

    <!-- Layer 7: Tests -->
    <div class="tab-panel" id="panel-layer-7"><div id="content-layer-7"></div></div>

  </main>

  <footer style="text-align:center;padding:32px;color:var(--ink-ghost);font-size:12px;font-family:'IBM Plex Mono',monospace;">
    SplitLease Design Stack v2.0 — Element Pipeline
  </footer>

  <script>
    function loadJSON(id) { try { return JSON.parse(document.getElementById(id)?.textContent || '{}'); } catch { return {}; } }

    const config = loadJSON('run-config');
    const layers = {};
    for (let i = 0; i <= 7; i++) layers[i] = loadJSON(`data-layer-${i}`);

    // Header
    const lens = config.lens || layers[0]?.lens || {};
    document.getElementById('lens-label').textContent = `Lens: ${lens.host_call || '?'} + ${lens.book_extract || '?'}`;
    document.getElementById('meta-date').textContent = config.started_at ? new Date(config.started_at).toLocaleDateString() : '';
    document.getElementById('meta-run-id').textContent = config.run_id || '';
    const statusEl = document.getElementById('meta-status');
    statusEl.textContent = config.status || 'pending';
    statusEl.className = `badge badge-${config.status || 'partial'}`;

    // Count elements
    let totalElements = 0;
    for (let i = 1; i <= 5; i++) totalElements += (layers[i]?.elements || []).length;
    totalElements += (layers[7]?.elements || []).length;
    document.getElementById('meta-elements').textContent = `${totalElements} elements`;

    // Coherence bar
    const coherence = layers[6] || {};
    const contradictions = coherence.contradictions || [];
    const reinforcements = coherence.reinforcements || [];
    if (contradictions.length > 0) {
      const bar = document.getElementById('coherence-bar');
      bar.classList.add('has-flags');
      document.getElementById('coherence-count').textContent = `${contradictions.length} contradiction${contradictions.length !== 1 ? 's' : ''}`;
      document.getElementById('coherence-summary').textContent = `${reinforcements.length} reinforcement${reinforcements.length !== 1 ? 's' : ''} found`;
    }

    // Tab navigation
    document.getElementById('tab-nav').addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      document.querySelectorAll('.tab-nav button').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(`panel-${btn.dataset.tab}`).classList.add('active');
    });

    // Evidence toggle
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('evidence-toggle')) {
        const list = e.target.nextElementSibling;
        list.classList.toggle('open');
        e.target.textContent = list.classList.contains('open') ? 'Hide evidence' : `Show evidence (${list.children.length})`;
      }
    });

    // Render element card
    function renderElementCard(el) {
      const phases = (el.journey_phases || []).map(p => `<span class="phase-tag">${p}</span>`).join('');
      const evidenceItems = (el.evidence || []).map(ev =>
        `<div class="evidence-item">
          <div class="source">${ev.source || ''}</div>
          ${ev.quote ? `<div class="quote">"${ev.quote}"</div>` : ''}
          ${ev.insight ? `<div class="insight">${ev.insight}</div>` : ''}
        </div>`
      ).join('');
      const evidenceCount = (el.evidence || []).length;

      let extras = '';
      // Layer-specific fields
      if (el.user_goal) extras += `<div class="extra-field"><label>User Goal</label> <span class="value">${el.user_goal}</span></div>`;
      if (el.company_goal) extras += `<div class="extra-field"><label>Company Goal</label> <span class="value">${el.company_goal}</span></div>`;
      if (el.success_metric) extras += `<div class="extra-field"><label>Success Metric</label> <span class="value">${el.success_metric}</span></div>`;
      if (el.time_budget) extras += `<div class="extra-field"><label>Time Budget</label> <span class="value">${el.time_budget}</span></div>`;
      if (el.hierarchy_principle) extras += `<div class="extra-field"><label>Hierarchy</label> <span class="value">${el.hierarchy_principle}</span></div>`;
      if (el.disclosure_pattern) extras += `<div class="extra-field"><label>Disclosure</label> <span class="value">${el.disclosure_pattern}</span></div>`;
      if (el.cognitive_load_constraint) extras += `<div class="extra-field"><label>Cognitive Load</label> <span class="value">${el.cognitive_load_constraint}</span></div>`;
      if (el.brand_alignment) extras += `<div class="extra-field"><label>Brand Alignment</label> <span class="value">${el.brand_alignment}</span></div>`;
      if (el.visual_hierarchy_rule) extras += `<div class="extra-field"><label>Visual Hierarchy</label> <span class="value">${el.visual_hierarchy_rule}</span></div>`;
      if (el.transition_principle) extras += `<div class="extra-field"><label>Transitions</label> <span class="value">${el.transition_principle}</span></div>`;
      if (el.journey_state_awareness) extras += `<div class="extra-field"><label>Journey Awareness</label> <span class="value">${el.journey_state_awareness}</span></div>`;
      if (el.target_emotion) extras += `<div class="extra-field"><label>Target Emotion</label> <span class="value" style="font-size:16px;font-weight:600;">${el.target_emotion}</span></div>`;
      if (el.emotion_rationale) extras += `<div class="extra-field"><label>Why</label> <span class="value">${el.emotion_rationale}</span></div>`;
      if (el.validation_method) extras += `<div class="extra-field"><label>Method</label> <span class="value">${el.validation_method}</span></div>`;
      if (el.success_criteria) extras += `<div class="extra-field"><label>Success Criteria</label> <span class="value">${el.success_criteria}</span></div>`;
      if (el.failure_meaning) extras += `<div class="extra-field"><label>Failure Means</label> <span class="value">${el.failure_meaning}</span></div>`;
      if (el.test_description) extras += `<div class="extra-field"><label>Test</label> <span class="value">${el.test_description}</span></div>`;

      // Copy guidelines
      if (el.copy_guidelines) {
        const cg = el.copy_guidelines;
        extras += `<div class="extra-field" style="margin-top:8px;"><label>Copy Voice</label> <span class="value">${cg.voice || ''}</span></div>`;
        if (cg.example_good) extras += `<div class="extra-field"><label>Good Example</label> <span class="value" style="color:var(--signal-success);">"${cg.example_good}"</span></div>`;
        if (cg.example_bad) extras += `<div class="extra-field"><label>Bad Example</label> <span class="value" style="color:var(--signal-danger);text-decoration:line-through;">"${cg.example_bad}"</span></div>`;
      }

      // Anti-goals / anti-patterns
      const antiItems = el.anti_goals || (el.anti_patterns || []).map(a => typeof a === 'string' ? a : a.pattern);
      let antiHTML = '';
      if (antiItems && antiItems.length) {
        antiHTML = `<div style="margin-top:12px;"><label style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;color:var(--signal-danger);font-family:'IBM Plex Mono',monospace;">Anti-goals</label><ul style="margin-top:4px;padding-left:18px;font-size:13px;color:var(--ink-soft);">${antiItems.map(a => `<li>${a}</li>`).join('')}</ul></div>`;
      }

      return `<div class="element-card">
        <div class="element-card-header">
          <h3>${el.title || el.id}</h3>
          <span class="type-badge type-${el.type || ''}">${(el.type || '').replace(/_/g, ' ')}</span>
          <span class="priority-badge priority-${el.priority || 'low'}">${el.priority || 'low'}</span>
        </div>
        <div class="phase-tags">${phases}</div>
        <div class="ps-grid">
          <div class="ps-box problem"><label>Problem</label>${el.problem || 'N/A'}</div>
          <div class="ps-box solution"><label>Solution</label>${el.solution || 'N/A'}</div>
        </div>
        ${extras ? `<div class="extra-fields">${extras}</div>` : ''}
        ${antiHTML}
        ${evidenceCount > 0 ? `<div style="margin-top:16px;">
          <button class="evidence-toggle">Show evidence (${evidenceCount})</button>
          <div class="evidence-list">${evidenceItems}</div>
        </div>` : ''}
      </div>`;
    }

    // Render element layers (1-5, 7)
    [1,2,3,4,5,7].forEach(i => {
      const container = document.getElementById(`content-layer-${i}`);
      if (!container) return;
      const data = layers[i];
      const elements = data?.elements || [];
      if (elements.length === 0) {
        container.innerHTML = '<div class="element-card"><p style="color:var(--ink-ghost);font-style:italic;">No elements discovered by this layer.</p></div>';
        return;
      }
      const layerNames = {1:'Process Patterns',2:'Info Architecture',3:'Visual Patterns',4:'Interaction Patterns',5:'Emotional Elements',7:'Validation Strategies'};
      container.innerHTML = `<h2 style="font-family:'Instrument Serif',serif;font-size:24px;font-weight:400;margin-bottom:20px;">Layer ${i}: ${layerNames[i]} <span style="font-size:14px;color:var(--ink-muted);font-family:'IBM Plex Mono',monospace;">(${elements.length} element${elements.length!==1?'s':''})</span></h2>` + elements.map(renderElementCard).join('');
    });

    // Render Layer 0: Journey Context
    (function renderJourney() {
      const container = document.getElementById('content-layer-0');
      if (!container) return;
      const data = layers[0];
      if (!data || !data.phases) { container.innerHTML = '<p style="color:var(--ink-ghost);font-style:italic;">No journey context data.</p>'; return; }

      const phaseOrder = ['discovery','evaluation','onboarding','listing_creation','pricing','proposal_mgmt','active_lease','retention'];
      let html = '';
      if (data.lens?.lens_summary) html += `<p style="font-size:15px;color:var(--ink-soft);margin-bottom:20px;">${data.lens.lens_summary}</p>`;
      phaseOrder.forEach(phase => {
        const p = data.phases[phase];
        if (!p) return;
        const risk = p.dropout_risk?.level || 'low';
        html += `<div class="phase-card">
          <h4>${phase.replace(/_/g, ' ')}</h4>
          <p>${p.what_this_lens_reveals || 'No data for this phase.'}</p>
          ${p.user_state ? `<p style="font-size:12px;color:var(--ink-muted);"><strong>Emotional:</strong> ${p.user_state.emotional_state || '?'} | <strong>Knowledge:</strong> ${p.user_state.knowledge_level || '?'} | <strong>Commitment:</strong> ${p.user_state.commitment_level || '?'}</p>` : ''}
          <span class="risk risk-${risk}">${risk} dropout risk</span>
        </div>`;
      });
      if (data.cross_phase_patterns?.length) {
        html += '<h4 style="font-family:\'IBM Plex Mono\',monospace;font-size:13px;font-weight:600;color:var(--accent);margin:20px 0 10px;text-transform:uppercase;">Cross-Phase Patterns</h4>';
        data.cross_phase_patterns.forEach(cp => {
          html += `<div class="phase-card"><p><strong>${cp.pattern}</strong></p><p style="font-size:12px;color:var(--ink-muted);">Affects: ${(cp.phases_affected||[]).join(', ')} | ${cp.evidence || ''}</p></div>`;
        });
      }
      container.innerHTML = html;
    })();

    // Render Layer 6: Coherence
    (function renderCoherence() {
      const container = document.getElementById('content-layer-6');
      if (!container) return;
      const data = layers[6];
      if (!data || Object.keys(data).length === 0) { container.innerHTML = '<div class="element-card"><p style="color:var(--ink-ghost);font-style:italic;">No coherence data.</p></div>'; return; }

      let html = '';

      // Reinforcements
      if (data.reinforcements?.length) {
        html += `<div class="coherence-section"><h3>Reinforcements (${data.reinforcements.length})</h3>`;
        data.reinforcements.forEach(r => {
          html += `<div class="reinforcement-card"><div class="card-label" style="color:var(--signal-success);">Reinforcement</div>
            <p><strong>${r.new_element_id}</strong> reinforces <strong>${r.existing_element_id}</strong></p>
            <p style="font-size:13px;color:var(--ink-soft);margin-top:4px;">${r.similarity || ''}</p>
            <p style="font-size:12px;color:var(--ink-muted);margin-top:4px;">Recommendation: ${r.recommendation || ''}</p>
          </div>`;
        });
        html += '</div>';
      }

      // Contradictions
      if (data.contradictions?.length) {
        html += `<div class="coherence-section"><h3>Contradictions (${data.contradictions.length})</h3>`;
        data.contradictions.forEach(c => {
          html += `<div class="contradiction-card"><div class="card-label" style="color:var(--signal-danger);">${c.severity || 'warning'}</div>
            <p><strong>${c.new_element_id}</strong> conflicts with <strong>${c.existing_element_id}</strong></p>
            <p style="font-size:13px;color:var(--ink-soft);margin-top:4px;">${c.conflict || ''}</p>
            <p style="font-size:12px;color:var(--ink-muted);margin-top:4px;">Recommendation: ${c.recommendation || ''}</p>
          </div>`;
        });
        html += '</div>';
      }

      // Extensions
      if (data.extensions?.length) {
        html += `<div class="coherence-section"><h3>Extensions (${data.extensions.length})</h3>`;
        data.extensions.forEach(ext => {
          html += `<div class="extension-card"><div class="card-label" style="color:var(--signal-info);">New Territory</div>
            <p><strong>${ext.new_element_id}</strong> — ${ext.gap_filled || ''}</p>
            <p style="font-size:12px;color:var(--ink-muted);margin-top:4px;">${ext.confidence_note || ''}</p>
          </div>`;
        });
        html += '</div>';
      }

      // Coverage Map
      if (data.coverage_map) {
        html += '<div class="coherence-section"><h3>Journey Coverage</h3><div class="coverage-grid">';
        Object.entries(data.coverage_map).forEach(([phase, info]) => {
          const cov = info.coverage || 'none';
          html += `<div class="coverage-cell coverage-${cov}">
            <div class="phase-name">${phase.replace(/_/g, ' ')}</div>
            <div class="count">${info.element_count || 0}</div>
            <div class="level">${cov}</div>
          </div>`;
        });
        html += '</div></div>';
      }

      // Emotional Arc
      if (data.emotional_arc_check) {
        const arc = data.emotional_arc_check;
        html += `<div class="coherence-section"><h3>Emotional Arc</h3>`;
        if (arc.journey_emotion_map?.length) {
          html += '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">';
          arc.journey_emotion_map.forEach(em => {
            html += `<div style="padding:8px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:12px;text-align:center;">
              <div style="font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--ink-muted);text-transform:uppercase;">${em.phase}</div>
              <div style="font-weight:600;color:var(--accent);margin-top:2px;">${(em.target_emotions||[]).join(', ')}</div>
            </div>`;
          });
          html += '</div>';
        }
        if (arc.arc_assessment) html += `<p style="font-size:14px;color:var(--ink-soft);">${arc.arc_assessment}</p>`;
        html += '</div>';
      }

      container.innerHTML = html || '<div class="element-card"><p style="color:var(--ink-ghost);font-style:italic;">No coherence issues detected.</p></div>';
    })();

    // Overview tab
    (function renderOverview() {
      // Coverage
      const coverageContainer = document.getElementById('overview-coverage');
      const coverageData = layers[6]?.coverage_map;
      if (coverageData && coverageContainer) {
        Object.entries(coverageData).forEach(([phase, info]) => {
          const cov = info.coverage || 'none';
          coverageContainer.innerHTML += `<div class="coverage-cell coverage-${cov}">
            <div class="phase-name">${phase.replace(/_/g,' ')}</div>
            <div class="count">${info.element_count||0}</div>
            <div class="level">${cov}</div>
          </div>`;
        });
      }

      // Lens summary
      const summaryEl = document.getElementById('overview-lens-summary');
      if (summaryEl) summaryEl.textContent = layers[0]?.lens?.lens_summary || 'No lens summary available.';

      // Stats
      const statsEl = document.getElementById('overview-stats');
      if (statsEl) {
        const stats = [
          { label: 'Elements', value: totalElements },
          { label: 'Reinforcements', value: reinforcements.length },
          { label: 'Contradictions', value: contradictions.length },
          { label: 'Extensions', value: (coherence.extensions||[]).length }
        ];
        statsEl.innerHTML = stats.map(s =>
          `<div style="padding:14px;background:var(--surface-warm);border:1px solid var(--border);border-radius:var(--radius-md);text-align:center;">
            <div style="font-size:28px;font-weight:700;color:var(--accent);">${s.value}</div>
            <div style="font-size:11px;font-family:'IBM Plex Mono',monospace;color:var(--ink-muted);text-transform:uppercase;">${s.label}</div>
          </div>`
        ).join('');
      }

      // High-priority highlights
      const highlightsEl = document.getElementById('overview-highlights');
      if (highlightsEl) {
        let highPriority = [];
        [1,2,3,4,5,7].forEach(i => {
          (layers[i]?.elements || []).forEach(el => {
            if (el.priority === 'high') highPriority.push(el);
          });
        });
        if (highPriority.length) {
          highlightsEl.innerHTML = `<h2 style="font-family:'Instrument Serif',serif;font-size:22px;font-weight:400;margin:24px 0 16px;">High-Priority Elements</h2>` + highPriority.map(renderElementCard).join('');
        }
      }
    })();
  </script>
</body>
</html>
